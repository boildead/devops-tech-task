---
- name: Install Grafana
  hosts: production
  become: true

  tasks:
    - name: Create Grafana provisioning directory
      ansible.builtin.file:
        path: "/etc/grafana/provisioning/datasources"
        state: directory
        mode: '0755'

    - name: Copy Grafana configuration file
      ansible.builtin.copy:
        src: ds.yml
        dest: /etc/grafana/provisioning/datasources/ds.yml
        mode: '0644'

    - name: Start Grafana container
      community.docker.docker_container:
        name: grafana
        image: grafana/grafana:{{ grafana_version }}
        restart_policy: unless-stopped
        networks:
          - name: monitoring
        ports:
          - "3000:3000"
        volumes:
          - grafana-data:/var/lib/grafana
          - /etc/grafana/provisioning:/etc/grafana/provisioning
        state: started
        env:
          GF_SECURITY_ADMIN_PASSWORD: "{{ grafana_admin_password }}"
          GF_PATHS_PROVISIONING: "/etc/grafana/provisioning"
